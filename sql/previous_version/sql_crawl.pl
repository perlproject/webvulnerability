#!/usr/bin/perl
use warnings;
use strict;
use 5.010;

use threads;
use threads::shared;
use WWW::Mechanize;
use Thread::Queue;
use URI;

require 'sql_scan.pl';
require 'sql_attack.pl';

my %argv_info = @ARGV;

my $url;
if(exists $argv_info{-u})
{
    $url = $argv_info{-u}; 
}
else
{
    say "주소값을 입력하세요";
    exit;
}

my $max_depth = 1;
if(exists $argv_info{-d})
{
    $max_depth = $argv_info{-d};
}

my $thread_limit = 1;
if(exists $argv_info{-t})
{
    $thread_limit = $argv_info{-t};
}

my $crawl = WWW::Mechanize->new();
eval{ $crawl->get($url) };

my %crawl_urls :shared;
$crawl_urls{$url}=1;

my @links = $crawl->find_all_links;
my $keyword = (split /:\/\//, $url)[1];
my @urls;
for my $link (@links)
{
    my $url = $link->url_abs();
    next unless $url =~ /$keyword/;
    push @urls, $url;
}

my $queue  = new Thread::Queue(@urls);
$queue->enqueue('--');

my $depth :shared=0;
my @thr = map {threads->create(\&crawl);} 1..$thread_limit;
$_->join() for @thr;

sub crawl
{
    while($queue->pending()>0 and $max_depth>$depth)
    {
        my $url = $queue->dequeue;

        if($url eq '--')
        {
            $depth++;
            $queue->enqueue('--');
            next;
        }
        next if $crawl_urls{$url};
        $crawl_urls{$url} = 1;
        
        eval{ $crawl->get($url) };
        
        my @links = $crawl->find_all_links;
        for my $link (@links)
        {
            my $url = $link->url_abs();
            next unless $url =~ /$keyword/;
            next if $crawl_urls{$url};
            $queue->enqueue($url);
        }
    }

}

say "-------CRAWL URLS-------";
say for keys %crawl_urls;

my %sql_scan = sql_scan($crawl, %crawl_urls);
sql_attack($crawl, \%sql_scan);
