#!/usr/bin/perl
use warnings;
use strict;
use threads;
use WWW::Mechanize;
use Thread::Queue;
use URI;
use 5.010;

require 'sql_scanning.pl';

my %crawl_urls;
my %crawl_form_urls;

my $url = shift || "Please provide an initial source URL";
my $max_depth = shift || 1;
my $depth=0;
my $keyword = (split /:\/\//, $url)[1];
my $crawl = WWW::Mechanize->new();

$crawl->get($url);
#eval{ $crawl->get($url) };
$crawl_urls{$url}=1;

my (@form_text_name, $form_action, $form_name, $form_method, @input_tags);
my @forms = $crawl->forms;

for my $form (@forms)
{
    $form_method = $form->method;
    next unless $form_method eq "POST";
    next unless $form->action =~ /$keyword/;
    $form_action = $form->action;
    $form_name = $form->attr("name");
    next unless defined $form_name;

    @input_tags = $form->inputs;

    for my $input (@input_tags)
    {
        next unless defined $input;
        my ($input_type, $input_name);
        $input_type = $input->type;
        next unless $input->type eq 'text';
        $input_name = $input->name;
        push @form_text_name, $input_name;
    }
    next unless @form_text_name;
    my $value = join ' ', $form_action, $form_name, 
                            $form_method, @form_text_name;
    $crawl_form_urls{$url} = $value;
    @form_text_name = '';
}

my @links = $crawl->find_all_links;
my @urls;
for my $link (@links)
{
    my $url = $link->url_abs();
    push @urls, $url;
}

my $queue = new Thread::Queue(@urls);
$queue->enqueue('--');

while($queue->pending()>0 and $max_depth>$depth)
{
    my $url = $queue->dequeue;
    if($url eq '--')
    {
        $depth++;
        $queue->enqueue('--');
        next;
    }
    next if $crawl_urls{$url};
    $crawl_urls{$url} = 1;
    
    eval{ $crawl->get($url) };
    
    my @forms = $crawl->forms;

    for my $form (@forms)
    {
        $form_method = $form->method;
        next unless $form_method eq "POST";
        next unless $form_action =~ /$keyword/;
        $form_action = $form->action;
        $form_name = $form->attr("name");
        next unless defined $form_name;

        @input_tags = $form->inputs;

        for my $input (@input_tags)
        {
            next unless defined $input;
            my ($input_type, $input_name);
            $input_type = $input->type;
            next unless $input->type eq 'text';
            $input_name = $input->name;
            push @form_text_name, $input_name;
        }
        next unless @form_text_name;
        my $value = join ' ', $form_action, $form_name, 
                                $form_method, @form_text_name;
        $crawl_form_urls{$url} = $value;
        @form_text_name = '';
    }

    my @links = $crawl->find_all_links;
    for my $link (@links)
    {
        my $url = $link->url_abs();
        next if $crawl_urls{$url};
        $queue->enqueue($url);
    }
}

for my $url (keys %crawl_urls)
{
    next if $url =~ /$keyword/;
    delete $crawl_urls{$url};
}

for my $url (keys %crawl_urls)
{
    say "$url";
}

for my $url (keys %crawl_form_urls)
{
    say "$url : $crawl_form_urls{$url}";
}

sql_scanning($crawl, \%crawl_urls, \%crawl_form_urls);
                   
say "----------------------------------";

for my $url (keys %crawl_urls)
{
    say "$url";
}

for my $url (keys %crawl_form_urls)
{
    say "$url : $crawl_form_urls{$url}";
}
