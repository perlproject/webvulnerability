#!/usr/bin/perl
use warnings;
use strict;
use WWW::Mechanize;
use URI;
use 5.010;

sub sql_scanning
{
    my ($crawl, $crawl_urls, $crawl_form_urls) = @_;
    for my $url (keys %$crawl_urls)
    {
        my $uri = URI->new($url);
        my $query = $uri->query;
        next if $query;
        delete ${ $crawl_urls }{$url};
    }

    for my $url(keys %$crawl_urls) #sql weak point
    {
        my $abs_url = $url;
        $abs_url =~ s/=/='TEST/g;

        eval{ $crawl->get($abs_url) };
        my $response = $crawl->response;
        my $content = $response->decoded_content;
        if($content =~ /(Microsoft SQL|MySQL|ORA)/i)
        {
            ${ $crawl_urls }{$url} = $1;
        }
        else
        {
            delete ${ $crawl_urls }{$url};
        }
    }
    
    for my $url (keys %$crawl_form_urls)
    {
        eval{ $crawl->get($url) };
        my ($form_action, $form_name, $form_method, @form_text_name)
            = split ' ', ${ $crawl_form_urls }{$url};
        for my $text_name (@form_text_name)
        {
            next if $form_name eq "undef";
            my $response = $crawl->submit_form(
                    form_name => $form_name,
                    fields=> {$text_name => "'TEST",}
                    ,);

            my $content = $response->decoded_content;

            if($content =~ /(Microsoft|MySQL|ORA)/i)
            {
                ${ $crawl_form_urls }{$url} = $1;
            }
            else
            {
                delete ${ $crawl_form_urls }{$url};
            }
        }
    }
}
1;    
